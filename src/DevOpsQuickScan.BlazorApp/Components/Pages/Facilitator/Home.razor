@page "/facilitator"
@using DevOpsQuickScan.Core
@using DevOpsQuickScan.BlazorApp.Components.Partials
@inject UserIdService UserId
@inject SessionService Session

<PageTitle>Facilitation</PageTitle>

<h2>Facilitator Panel</h2>
<p>User / Session Id: @_userId</p>

@foreach (var question in Session.Questions)
{
    <div class="question-block" style="margin-bottom: 1.5rem;">
        @{ _revealedQuestion = Session.RevealedQuestion(question.Id);}
        <RevealComponent RevealedQuestion="@_revealedQuestion"/>

        <button @onclick="() => AskQuestion(question)" disabled="@question.IsRevealed">Ask</button>
        <button @onclick="() => RevealAnswers(question)">Reveal</button>
        <button @onclick="() => ResetQuestion(question)">Reset</button>
    </div>
}

@code {
    private string? _userId = null;
    private RevealedQuestion? _revealedQuestion;

    protected override async Task OnAfterRenderAsync(bool firstRender) =>
        _userId = await UserId.GetAsync();

    protected override async Task OnInitializedAsync()
    {
        Session.OnAnswerReceived += async (revealedQuestion) =>
        {
            _revealedQuestion = revealedQuestion;
            await InvokeAsync(StateHasChanged);
        };
    }


    private void AskQuestion(Question question) =>
        Session.AskQuestion(question.Id);

    private void RevealAnswers(Question question) =>
        Session.RevealQuestion(question.Id);

    private void ResetQuestion(Question question) =>
        Session.ResetQuestion(question.Id);

}